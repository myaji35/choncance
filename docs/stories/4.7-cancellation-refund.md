# Story 4.7: Booking Cancellation and Refund

## Status
Ready for Implementation

## Story
**As a** guest with an upcoming booking,
**I want** to cancel my reservation and receive a refund according to the cancellation policy,
**so that** I can adjust my travel plans if needed.

## Acceptance Criteria
1. "예약 취소" button visible on booking detail page (only for upcoming bookings)
2. Cancellation policy displayed before confirmation:
   - 7+ days before check-in: 100% refund
   - 3-6 days before: 50% refund
   - < 3 days: no refund
3. Cancellation modal shows refund amount based on policy
4. Guest must confirm cancellation
5. On confirmation, booking status updates to CANCELLED_BY_GUEST
6. Refund processed via Toss Payments cancellation API
7. Email notifications sent to guest and host
8. Cancellation appears in booking history with status badge
9. Cannot cancel within 24 hours of check-in (show error)
10. All UI and messages in Korean

## Tasks
- [ ] Add cancel button to booking detail page
- [ ] Create CancellationModal component
- [ ] Implement cancellation policy logic
- [ ] Calculate refund amount based on days until check-in
- [ ] Display policy and refund amount in modal
- [ ] Create Server Action: cancelBooking(bookingId, reason)
- [ ] Update booking status to CANCELLED_BY_GUEST
- [ ] Integrate Toss Payments cancel API
- [ ] Create refund record in database
- [ ] Send email notifications to guest and host
- [ ] Handle edge cases: < 24 hours, already checked in
- [ ] Testing: policy calculation, refund API, email notifications

## Dev Notes
**Cancellation Policy Logic:**
```typescript
const getCancellationRefund = (booking: Booking) => {
  const now = new Date();
  const checkIn = new Date(booking.checkIn);
  const daysUntilCheckIn = differenceInDays(checkIn, now);

  if (daysUntilCheckIn < 1) {
    return { allowed: false, message: '체크인 24시간 전에는 취소할 수 없습니다' };
  }

  if (daysUntilCheckIn >= 7) {
    return { allowed: true, refundRate: 1.0, refundAmount: booking.totalAmount };
  } else if (daysUntilCheckIn >= 3) {
    return { allowed: true, refundRate: 0.5, refundAmount: Math.floor(booking.totalAmount * 0.5) };
  } else {
    return { allowed: true, refundRate: 0, refundAmount: 0 };
  }
};
```

**Toss Payments Cancellation:**
```typescript
const response = await fetch('https://api.tosspayments.com/v1/payments/{transactionId}/cancel', {
  method: 'POST',
  headers: {
    'Authorization': `Basic ${Buffer.from(secretKey + ':').toString('base64')}`,
    'Content-Type': 'application/json',
  },
  body: JSON.stringify({
    cancelReason: reason,
    cancelAmount: refundAmount,
  })
});
```

**Korean Labels:** "예약 취소", "환불 금액", "취소 정책", "정말 취소하시겠습니까?"

## Change Log
| Date | Version | Author |
|------|---------|--------|
| 2025-10-27 | 1.0 | John (PM) |

## Priority: P0 | Story Points: 8 | Epic: Epic 4
