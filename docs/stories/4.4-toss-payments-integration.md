# Story 4.4: Toss Payments Integration

## Status
Ready for Implementation

## Story
**As a** guest completing a booking,
**I want** to pay securely using Toss Payments,
**so that** I can confirm my reservation with confidence.

## Acceptance Criteria
1. "결제하기" button initiates Toss Payments checkout
2. Payment methods: credit card, bank transfer, Toss Pay, Kakao Pay
3. Payment amount matches calculated total from 4.3
4. Payment success creates booking with status = CONFIRMED
5. Payment failure shows error message and allows retry
6. Payment data stored in database (transaction ID, method, amount)
7. Webhook handles async payment confirmation
8. Redirect to booking confirmation page on success
9. All payment UI in Korean
10. Complies with Korean PG regulations

## Tasks
- [ ] Setup Toss Payments account and get API keys
- [ ] Install @tosspayments/payment-sdk-v2
- [ ] Create payment preparation endpoint: POST /api/payments/prepare
- [ ] Implement TossPayments component with checkout widget
- [ ] Handle payment success callback
- [ ] Handle payment failure callback
- [ ] Create webhook endpoint: POST /api/webhooks/toss
- [ ] Verify webhook signature for security
- [ ] Create booking record on payment success
- [ ] Store transaction data in Payment model
- [ ] Redirect to /bookings/[id]/confirmation on success
- [ ] Testing: successful payment, failed payment, webhook processing

## Dev Notes
**Toss Payments SDK:**
```typescript
import { loadTossPayments } from '@tosspayments/payment-sdk';

const tossPayments = await loadTossPayments(process.env.TOSS_CLIENT_KEY!);

await tossPayments.requestPayment('카드', {
  amount: totalAmount,
  orderId: bookingId,
  orderName: `${property.name} 숙박`,
  customerName: user.name,
  successUrl: `${baseUrl}/api/payments/success`,
  failUrl: `${baseUrl}/api/payments/fail`,
});
```

**Database Models:**
```prisma
model Payment {
  id            String   @id @default(cuid())
  bookingId     String   @unique
  transactionId String   @unique
  method        String   // 'card', 'transfer', 'tosspay', 'kakaopay'
  amount        Int
  status        PaymentStatus
  paidAt        DateTime?
  createdAt     DateTime @default(now())

  booking       Booking  @relation(fields: [bookingId], references: [id])
}

enum PaymentStatus {
  PENDING
  COMPLETED
  FAILED
  CANCELLED
}
```

**Korean Labels:** "결제하기", "결제 수단 선택", "결제 완료", "결제 실패"

## Change Log
| Date | Version | Author |
|------|---------|--------|
| 2025-10-27 | 1.0 | John (PM) |

## Priority: P0 | Story Points: 13 | Epic: Epic 4
